# DeepCFR 推理指南

> **提示**：这是详细的技术文档。快速开始请参考 [README_TEXAS_HOLDEM.md](README_TEXAS_HOLDEM.md)

## 推理脚本

已创建简化的推理脚本 `inference_simple.py`，可以加载训练好的模型并进行推理。

## 使用方法

### 基本使用

```bash
# 运行 5 局游戏测试
python inference_simple.py --num_games 5
```

### 完整参数

```bash
python inference_simple.py \
    --model_prefix deepcfr_texas \  # 模型文件前缀
    --num_games 10 \                # 测试游戏数量
    --policy_layers 64 64 \         # 策略网络层大小（必须与训练时一致）
    --use_gpu                       # 使用 GPU
```

## 测试结果示例

```
======================================================================
DeepCFR 简化推理
======================================================================

使用设备: cuda

[0/2] 创建游戏...
  ✓ 游戏创建成功: universal_poker
  信息状态大小: 169
  动作数量: 4

[1/2] 加载模型...
  加载策略网络: deepcfr_texas_policy_network.pt
  ✓ 策略网络加载成功

[2/2] 测试模型 (5 局游戏)...
  进行第 5/5 局...

  测试结果:
    玩家 0:
      平均收益: 80.0000
      胜率: 60.0%
      总收益: 400.00
    玩家 1:
      平均收益: -80.0000
      胜率: 20.0%
      总收益: -400.00

======================================================================
✓ 推理完成
======================================================================
```

## 结果解读

- **玩家 0**：使用训练好的模型
  - 平均收益 > 0：说明模型策略有效
  - 胜率 > 50%：说明模型优于随机策略

- **玩家 1**：使用随机策略（对手）
  - 平均收益 < 0：正常，因为对手是随机策略

## 注意事项

1. **游戏配置必须一致**：
   - 推理时使用的游戏配置必须与训练时完全一致
   - 否则信息状态张量大小不匹配，无法加载模型

2. **网络结构必须一致**：
   - `--policy_layers` 参数必须与训练时一致
   - 默认是 `64 64`，如果训练时不同，需要指定

3. **模型文件**：
   - 需要 `{model_prefix}_policy_network.pt` 文件
   - 例如：`deepcfr_texas_policy_network.pt`

## 功能说明

### 1. 模型加载
- 直接加载策略网络权重
- 避免创建完整求解器（避免 PyTorch 导入问题）
- 支持 GPU 和 CPU

### 2. 游戏测试
- 与随机策略对局
- 统计平均收益和胜率
- 可以测试多局游戏

### 3. 动作选择
- 使用策略网络预测动作概率
- 根据概率采样动作
- 只考虑合法动作

## 文件说明

### `inference_simple.py`（推荐使用）✅

- **优点**：
  - 直接加载网络权重，不创建完整求解器
  - 避免 PyTorch 导入问题
  - 运行速度快
  - 已测试通过

- **使用方法**：
```bash
python inference_simple.py --num_games 5
```

### `inference_deep_cfr.py`（备用）

- **特点**：
  - 创建完整 DeepCFRSolver（包括优化器）
  - 可能遇到 PyTorch 2.9.0 导入问题
  - 功能更完整（可以使用完整求解器功能）

- **问题**：
  - 在创建优化器时可能卡住（PyTorch 环境问题）
  - 如果遇到问题，请使用 `inference_simple.py`

- **使用方法**：
```bash
python inference_deep_cfr.py --num_games 5
```

## 总结

推理功能已实现并测试通过：
- ✅ 模型加载成功
- ✅ 游戏运行正常
- ✅ 策略推理正常
- ✅ 测试结果显示模型有效（胜率 60%，平均收益 80）

可以使用 `inference_simple.py` 进行模型推理和测试。

